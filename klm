WITH EXTRACTED_IDS AS (
    SELECT 
        ACCT.EXTNL_ACCT_ID, 
        ROW_NUMBER() OVER (ORDER BY ACCT.EXTNL_ACCT_ID) AS ROWNUM
    FROM usrf_ingest.CDS_ASP_EOM_ACCT_SUM ACCT
    WHERE partition_date = '20241130' 
        AND ACCT.PLTFM_CD = 'C'
)
SELECT 
    P4.EXTNL_ACCT_ID,
    P4.RTL_TRD_TOT_CNT AS CBV106_RTNMTOT,
    P4.COLL_INQRY_TOT_CNT AS CBV96_COLINQ,
    P4.BKCRD_UTILZD_PCT AS UTILIZATION,
    P4.TRD_HGST_CR_LINE_AMT AS MAXLINE,
    P4.BKCRD_TOT_CNT AS CBV90_BCMNOT,
    P4.TRD_OPEN_LAST_12MO_CNT AS CBV114_TRDOPNL12,
    P4.TRD_INQRY_LAST_12MO_CNT AS CBV100_INQNML12D,
    P4.BKCRD_UTILZD_LAST_24MO_PCT AS UTILIZATION_LAST24,
    CAST((CASE 
            WHEN P4.COLL_ACTV_FLAG = 'Y' THEN '1'
            WHEN P4.COLL_ACTV_FLAG = 'N' THEN '0'
            ELSE P4.COLL_ACTV_FLAG
        END) AS STRING) AS CBV95_COLEFLAG,  -- Changed VARCHAR(1) to STRING for Hive compatibility
    P4.OLDEST_UNSECRD_REVL_TRD_MNTH_CNT AS AOT,
    P4.FIN_TRD_CNT AS CBV98_FNNMOT,
    P4.REVL_DEBT_TO_INCM_RTI AS RDTI,
    P4.BKCRD_LAST_OPEN_MNTH_CNT AS BCMR,
    P4.TRD_LAST_PAST_DUE_MNTH_CNT AS MNTHSBCDELL,
    P4.SNGL_RTL_CR_50PCT_UTILZD_CNT AS CBV104_RT50UTILZ,
    P4.BKCRD_TOT_CNT AS BKCRD_TOTCNT_DUP,
    P4.BKCRD_UTILZD_50PCT_CR_LMT_PCT AS TU_BC30,
    P4.BKCRD_UTILZD_50PCT_CR_LMT_CNT AS TU_BC50,
    P4.MTG_BAL_LAST_60_MO_TOT_AMT AS MTGBAL,
    P4.SIXTY_DAY_DLNCY_CNT AS SIXTYDELINQUENCYCOUNT,
    P4.TOT_INQRY_TOT_CNT AS TOTINQUIRIESCOUNT,
    P5.INQRY_TOT_CNT AS TOTINQUIRIESCOUNT_P5,
    P5.BANK_REVL_VRFD_TRD_LST_6MO_CNT AS TOTNUMOPENBANKREVTRADEVERIF6MO,
    P5.REVL_RTL_TRD_VRFD_LAST_6MO_CNT AS TOTNUMOPENREVTRADEVERIF6MO,
    P5.SFCTRY_TRD_TOT_CNT AS TOTNUMSATISFACTORYTRADE,
    P5.REVL_UTILZ_NON_BARC_AMT AS REVUTILIZATIONAMOUNT_XJ,
    P5.BKCRD_TRD_BAL_GTZ_CNT AS TOTNUMOPENBANKCARDSWITHABALGTO,
    P5.BKCRD_NB_LAST_6MO_BAL_GTZ_CNT AS NUMOPENBNKTRADEVER6MOBALGTO_XJ,
    P5.REVL_ACCT_UTLZ_AMT AS REVUTILIZATIONAMOUNT,
    P5.EMPIRICA_SCORE_NBR AS EMPIRICASCORE,
    P5.INQRY_ON_FILE_CNT AS TOTNUMINQUIRIESONFILE,
    P5.BANK_REVL_OLDST_TRD_MNTH_CNT AS AGEOLDESTBANKREVTRADE,
    P5.BKCRD_BAL_TO_CR_LINE_RATIO AS RATIOBANKCARDBALTOCREDITLINE,
    P5.BANK_REVL_NEWST_TRD_MNTH_CNT AS AGENEWESTBANKREVTRADE,
    P5.REVL_TRD_AGG_CR_LMT_AMT AS AGGREGATECREDITLIMITALLREVTRAD,
    P5.BANK_REVL_BAL_TO_CR_LMT_RATIO AS TOTALUTILIZATION,
    P5.BKCRD_TRD_NB_BAL2CR_LMT_RATIO AS RATIOPENBNKCRDBALTOCRDTLINE_XJ,
    P5.BKCRD_TRD_CNT AS BANKCARDTRADECOUNT,
    P5.TRD_30DPD_LAST_6MO_CNT AS TOTNUMTRADEHISTMOPGE2_6MO,
    P5.BKCRD_TRD_OPEN_HGST_CR_LMT_AMT AS HIGHCLOPENBANKCARDTRADE,
    P5.BKCRD_ALL_TRD_CNT AS TOTNUMALLBANKCARDTRADE,
    P5.VINTR_TRD_CLSR_CNT AS NUMVOLUNTARYTRADECLOSURES,
    P5.BKCRD_TRD_OPEN_HGST_BAL_AMT AS HIGHESTBALOPENBANKCARDTRADE,
    P5.BKCRD_TRD_BAL_TO_CR_LMT_RATIO AS UTILIZATIONOPENBANKCARDTRADE,
    P5.OLDST_TRD_OPEN_MNTH_CNT AS MOSINCEOLDESTTRADEOPENED
FROM EXTRACTED_IDS E1
LEFT JOIN USRF_INGEST.APPL_ANLYS_MIXED_FACT P4 
    ON E1.EXTNL_ACCT_ID = P4.EXTNL_ACCT_ID 
    AND P4.EXTNL_ACCT_ID IS NOT NULL 
    AND P4.PARTITION_DATE = '20241130'
LEFT JOIN USRF_INGEST.CDS_DMA_CR_BUREAU_TRU_C P5 
    ON E1.EXTNL_ACCT_ID = P5.EXTNL_ACCT_ID 
    AND P5.PARTITION_DATE = '20241130'
WHERE E1.ROWNUM <= 200;
