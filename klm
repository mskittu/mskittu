-- Missing partition dates between the table's MIN and MAX dates
WITH rng AS (
  SELECT
    to_date(from_unixtime(unix_timestamp(min(CAST(partition_date AS string)), 'yyyyMMdd'))) AS start_dt,
    to_date(from_unixtime(unix_timestamp(max(CAST(partition_date AS string)), 'yyyyMMdd'))) AS end_dt
  FROM usrf_ingest.cds_acct_tbal_prcng_c_eoc_fact
),
cal AS (
  -- build a date calendar day-by-day
  SELECT date_format(date_add(r.start_dt, s.pos), 'yyyyMMdd') AS partition_date
  FROM rng r
  LATERAL VIEW posexplode(split(space(datediff(r.end_dt, r.start_dt) + 1), ' ')) s AS pos, _
),
existing AS (
  SELECT DISTINCT CAST(partition_date AS string) AS partition_date
  FROM usrf_ingest.cds_acct_tbal_prcng_c_eoc_fact
)
SELECT c.partition_date AS missing_partition_date
FROM cal c
LEFT JOIN existing e
  ON e.partition_date = c.partition_date
WHERE e.partition_date IS NULL
ORDER BY c.partition_date;
