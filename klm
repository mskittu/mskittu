import subprocess
import pandas as pd

def fetch_source_intermediate_data_cc():
    try:
        # Define Multiple queries
        queries = src_intermediate_query_cmpltns_cc
        final_results = []
        
        for query_info in queries:
            table_name = query_info["table_name"]
            hive_query = query_info["query"]

            # Execute Hive query via subprocess
            hive_command = f"hive -e \"{hive_query}\""
            result = subprocess.run(
                hive_command, shell=True, check=True,
                stdout=subprocess.PIPE, stderr=subprocess.PIPE, universal_newlines=True
            )

            # Process Hive query output
            lines = result.stdout.strip().split('\n')
            
            # Ensure headers are present
            if not lines:
                raise ValueError("No data retrieved from Hive query.")
            
            columns = [col.strip() for col in lines[0].split('\t')]  # Extract column names
            data_lines = lines[1:]  # Exclude header row from data
            
            # Remove error lines on mismatch
            clean_data_lines = [line for line in data_lines if len(line.split('\t')) == len(columns)]
            values = [row.split('\t') for row in clean_data_lines]
            
            # Format results for CSV Output
            table_results = {
                "interm_table_name": [table_name] * len(values),
                "interm_column_name": columns * len(values),
                "results": values
            }
            df = pd.DataFrame(table_results)
            
            final_results.append(df)

        # Save fetched data to CSV
        for df in final_results:
            df.to_csv(output_path, mode='a', index=False, header=not os.path.exists(output_path))
        print(f"Hive Intermediate data saved to {output_path}")

        # Clean Hive Intermediate data before further processing
        clean_hive_intermediate_data(output_path)

        return final_results

    except Exception as e:
        print(f"Error fetching Hive data: {e}")
        raise
