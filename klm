WITH FMT_ACCT_C_1 AS (
    SELECT 
        P2.EXNTL_ACCT_ID,
        P2.PURCH_FRAUD_CO_AMT AS PURCH_FRAUD_CO_AMT,
        P2.CHRGOFF_AMT AS CHRGOFF_AMT_FMT,
        P2.CR_LMT_AMT AS CR_LMT_AMT_FMT,
        ROW_NUMBER() OVER (PARTITION BY P2.EXNTL_ACCT_ID ORDER BY P2.CHRGOFF_AMT) AS RANKS
    FROM FMT_ACCT_DBA.FMT_ACCT_C P2
    INNER JOIN EXTRACTED_IDS E1 ON E1.EXNTL_ACCT_ID = P2.EXNTL_ACCT_ID
    WHERE P2.EFF_DT BETWEEN TO_DATE('20241101', 'YYYYMMDD') AND TO_DATE('20241130', 'YYYYMMDD')
    AND P2.SFX_NBR = '0'
)
SELECT 
    EXNTL_ACCT_ID,
    SUM(CHRGOFF_AMT_FMT) AS CHRGOFF_AMT, 
    DENSE_RANK() OVER (PARTITION BY EXNTL_ACCT_ID ORDER BY EFF_DT) AS RN_FRAUD
FROM FMT_ACCT_C_1
WHERE SFX_NBR = '0'
AND PARTITION_DATE = 'LAST DATE PREV MONTH'
AND (ACCT_STATUS_RSN_TXT LIKE '%CORF%' OR ACCT_STATUS_RSN_TXT LIKE '%CORT%')
AND (CHRGOFF_DT IS NOT NULL AND CHRGOFF_DT BETWEEN '20241101' AND '20241130')
GROUP BY EXNTL_ACCT_ID;
