WITH acct_cycle AS (
    SELECT
        acct_cyc.extnl_acct_id,
        acct_cyc.annl_fee_dscr,
        acct_cyc.eff_dt,
        ROW_NUMBER() OVER (
            PARTITION BY acct_cyc.extnl_acct_id
            ORDER BY acct_cyc.eff_dt DESC
        ) AS rn_cycle_c
    FROM src_stmt_dba.acct_cycl_c acct_cyc
    WHERE acct_cyc.eff_dt = TO_DATE('20251130','YYYYMMDD')
),
acct_cycle_fnl AS (
    SELECT
        p7.extnl_acct_id,
        CAST(
            CASE WHEN p7.annl_fee_dscr IS NULL THEN 'N' ELSE 'Y' END
            AS VARCHAR2(1)
        ) AS ccar_subj_ann_fee
    FROM acct_cycle p7
    INNER JOIN extracted_ids e1
        ON e1.extnl_acct_id = p7.extnl_acct_id
    WHERE p7.rn_cycle_c = 1
)
SELECT *
FROM acct_cycle_fnl;
