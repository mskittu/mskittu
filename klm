-- Consolidated SQL Query for All Tables and Attributes

-- Step 1: Extract 1000 IDs from each PCDS table and use them for the joins
WITH extracted_ids_asp AS (
    SELECT DISTINCT EXTNL_ACCT_ID
    FROM dmt_asp_dba.asp_eom_acct_sum
    FETCH FIRST 1000 ROWS ONLY
),
extracted_ids_fmt_acct AS (
    SELECT DISTINCT EXTNL_ACCT_ID
    FROM fmt_acct_dba.fmt_acct_c
    FETCH FIRST 1000 ROWS ONLY
),
extracted_ids_appl_anlys AS (
    SELECT DISTINCT EXTNL_ACCT_ID
    FROM fmt_appl_dba.appl_anlys_mixed_fact
    FETCH FIRST 1000 ROWS ONLY
),
extracted_ids_dma_cr_burau AS (
    SELECT DISTINCT EXTNL_ACCT_ID
    FROM dma_demo_dba.dma_cr_burau_tru_c
    FETCH FIRST 1000 ROWS ONLY
)

-- Step 2: Query data for all attributes from Hive tables
SELECT 
    -- Attributes from Hive table ingest.CDS_ASP_EOM_ACCT_SUM
    t1.EXTNL_ACCT_ID AS EXTNL_ACCT_ID_ASP,
    t1.cd41 AS cd41,
    t1.any_chrgoff_ever_flag AS any_chrgoff_ever_flag,
    t1.cash_advnc_cnt AS cash_advnc_cnt,
    t1.revl_flag AS revl_flag,
    t1.scrtzn_pool_cd AS scrtzn_pool_cd,
    t1.end_of_prd_abl_amt AS end_of_prd_abl_amt,
    t1.dlnqt_cd AS dlnqt_cd,
    t1.cr_lmt_amt AS cr_lmt_amt_asp,

    -- Attributes from Hive table rft_ingest.cds_acct_c
    t2.cr_lmt_amt AS cr_lmt_amt_fmt,

    -- Attributes from Hive table ingest.apply_anlys_mix_full_base
    t3.abv106_rtnmtot AS abv106_rtnmtot,
    t3.cbv96_colinq AS cbv96_colinq,
    t3.mosinceoldesttradeopened AS mosinceoldesttradeopened,
    t3.tu_s004 AS tu_s004,

    -- Attributes from Hive table rft_ingest.cds_dma_cr_burau_tru_c
    t4.mtgbal AS mtgbal,
    t4.sixtdelinquencycount AS sixtdelinquencycount,
    t4.totinquiriescount AS totinquiriescount,
    t4.totnumopenbankrevtradeverif6mo AS totnumopenbankrevtradeverif6mo,
    t4.totnumopenrevtradeverif6mo AS totnumopenrevtradeverif6mo,
    t4.totnumastisfactorytrade AS totnumastisfactorytrade,
    t4.revutilizationamount_xj AS revutilizationamount_xj

FROM 
    -- Join for ingest.CDS_ASP_EOM_ACCT_SUM
    extracted_ids_asp ei_asp
    LEFT JOIN ingest.cds_asp_eom_acct_sum t1
        ON ei_asp.EXTNL_ACCT_ID = t1.EXTNL_ACCT_ID

    -- Join for rft_ingest.cds_acct_c
    LEFT JOIN extracted_ids_fmt_acct ei_fmt_acct
    LEFT JOIN rft_ingest.cds_acct_c t2
        ON ei_fmt_acct.EXTNL_ACCT_ID = t2.EXTNL_ACCT_ID

    -- Join for ingest.apply_anlys_mix_full_base
    LEFT JOIN extracted_ids_appl_anlys ei_appl_anlys
    LEFT JOIN ingest.apply_anlys_mix_full_base t3
        ON ei_appl_anlys.EXTNL_ACCT_ID = t3.EXTNL_ACCT_ID

    -- Join for rft_ingest.cds_dma_cr_burau_tru_c
    LEFT JOIN extracted_ids_dma_cr_burau ei_dma_cr_burau
    LEFT JOIN rft_ingest.cds_dma_cr_burau_tru_c t4
        ON ei_dma_cr_burau.EXTNL_ACCT_ID = t4.EXTNL_ACCT_ID;
