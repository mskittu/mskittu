#!/bin/bash

# Database connection details
DB_HOST="your_db_host"
DB_USER="your_db_user"
DB_PASS="your_db_password"
DB_NAME="your_db_name"

# Output file path
FINAL_REPORT="final_report.csv"

# Email details
EMAIL_RECIPIENT="recipient@example.com"
EMAIL_SUBJECT="Final Combined Report"

# Initialize the final report with headers
echo "Project_Name,Module_Name,Query" > $FINAL_REPORT

# Execute Query 1 and append results to the final report
echo "Running Query 1..."
QUERY_1="SELECT PTN_VAL_TXT, portfolio, SOLD_FLAG, SUM(rcvry_actl_tot_amt), SUM(rcvry_actl_paymt_amt), COUNT(*)
FROM pub_rft_mdl.fin_mds_fact_mtd_c 
WHERE PTN_VAL_TXT >= '20240930' 
GROUP BY PTN_VAL_TXT, portfolio, SOLD_FLAG;"
mysql -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME -e "$QUERY_1" | sed '1d' | while IFS=$'\t' read -r line; do
  echo "Project_Name_1,Module_Name_1,\"$QUERY_1\"" >> $FINAL_REPORT
done

# Execute Query 2 and append results to the final report
echo "Running Query 2..."
QUERY_2="SELECT PTN_VAL_TXT, COUNT(*), SUM(ifrs_hram_flag), SUM(pty_id)
FROM pub_rft_mdl.fin_mds_fact_mtd_c
WHERE PTN_VAL_TXT >= '20240930'
GROUP BY PTN_VAL_TXT;"
mysql -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME -e "$QUERY_2" | sed '1d' | while IFS=$'\t' read -r line; do
  echo "Project_Name_2,Module_Name_2,\"$QUERY_2\"" >> $FINAL_REPORT
done

# Execute Query 3 and append results to the final report
echo "Running Query 3..."
QUERY_3="SELECT cob_date, pltfm_snp, COUNT(*), SUM(hram_flag)
FROM cuic_core.ifrs_pre_default_mrd_fact
WHERE cob_date >= '20240430'
GROUP BY cob_date, pltfm_snp;"
mysql -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME -e "$QUERY_3" | sed '1d' | while IFS=$'\t' read -r line; do
  echo "Project_Name_3,Module_Name_3,\"$QUERY_3\"" >> $FINAL_REPORT
done

# Email the final report
echo "Sending the final report..."
echo "Please find the attached final combined report." | mail -s "$EMAIL_SUBJECT" -A $FINAL_REPORT $EMAIL_RECIPIENT

# Cleanup (optional)
echo "Cleaning up temporary files..."
rm $FINAL_REPORT

echo "Final report generated and emailed successfully."
