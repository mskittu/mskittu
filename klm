WITH acct_cycle AS (
    SELECT
        acct_cyc.extnl_acct_id,
        acct_cyc.annl_fee_dscr,
        acct_cyc.eff_dt,
        ROW_NUMBER() OVER (
            PARTITION BY acct_cyc.extnl_acct_id
            ORDER BY acct_cyc.eff_dt DESC
        ) AS rn_cycle_c
    FROM src_stmt_dba.acct_cycl_c acct_cyc
    WHERE acct_cyc.partition_date = '20251130'
)
SELECT
    a.extnl_acct_id,
    CAST(
        CASE
            WHEN a.annl_fee_dscr IS NULL THEN 'N'
            ELSE 'Y'
        END AS VARCHAR2(1)
    ) AS ccar_subj_ann_fee
FROM acct_cycle a
JOIN dmt_asp_dba.asp_eom_acct_sum asp
    ON asp.extnl_acct_id = a.extnl_acct_id
WHERE a.rn_cycle_c = 1
  AND asp.partition_date = '20251130'
  AND asp.pltfm_cd = 'C';
