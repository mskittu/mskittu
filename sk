#!/bin/bash

# Database credentials
DB_USER="your_username"
DB_PASS="your_password"
DB_SID="your_sid"

# Input and output files
QUERY_FILE="pcds_tbl_par.txt"
OUTPUT_FILE="source.csv"

# Check if input file exists
if [[ ! -f "$QUERY_FILE" ]]; then
    echo "Error: Query file $QUERY_FILE not found!"
    exit 1
fi

# Clear the output file and add headers
echo "Table Name,Row Count" > "$OUTPUT_FILE"

# Process each line in the input file
while IFS= read -r line; do
    # Parse the table name and conditions
    table_name=$(echo "$line" | awk -F ',' '{print $3}' | xargs)
    condition=$(echo "$line" | awk -F ',' '{print $4}' | xargs)
    
    # Construct the SQL query
    sql_query="SELECT COUNT(*) FROM $table_name WHERE $condition;"

    # Execute the query using sqlplus and capture the result
    row_count=$(sqlplus -s "$DB_USER/$DB_PASS@$DB_SID" <<EOF
SET FEEDBACK OFF
SET HEADING OFF
SET PAGESIZE 0
SET TRIMSPOOL ON
$sql_query
EXIT;
EOF
)

    # Append the table name and row count to the CSV file
    echo "$table_name,$row_count" >> "$OUTPUT_FILE"
done < "$QUERY_FILE"

echo "Queries executed. Results saved to $OUTPUT_FILE."
