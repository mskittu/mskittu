from pyhive import hive
import cx_Oracle
import pandas as pd

# Hive connection setup
def connect_hive():
    conn = hive.Connection(host='your_hive_host', port=10000, username='your_username', database='default')
    return conn

# Oracle connection setup
def connect_oracle():
    dsn = cx_Oracle.makedsn('your_oracle_host', 1521, service_name='your_service_name')
    conn = cx_Oracle.connect(user='your_username', password='your_password', dsn=dsn)
    return conn

# Query to fetch data from Hive
def fetch_hive_data(query, conn):
    return pd.read_sql(query, conn)

# Query to fetch data from Oracle
def fetch_oracle_data(query, conn):
    return pd.read_sql(query, conn)

# Sample queries to fetch data
ppnr_hive_query = """
SELECT * FROM CDS_ASP_EOM_ACCT_SUM
WHERE account_id IN (SELECT account_id FROM some_filter_table LIMIT 1000)
"""

ppnr_oracle_query = """
SELECT * FROM asp_eom_acct_sum
WHERE account_id IN (SELECT account_id FROM some_filter_table WHERE ROWNUM <= 1000)
"""

# Generate accuracy report
def generate_accuracy_report(hive_data, oracle_data, attribute_name):
    merged_data = pd.merge(hive_data, oracle_data, on='account_id', suffixes=('_hive', '_oracle'))
    merged_data['accuracy'] = merged_data[f'{attribute_name}_hive'] == merged_data[f'{attribute_name}_oracle']
    accuracy_score = merged_data['accuracy'].mean() * 100

    return merged_data, accuracy_score

# Main workflow
def main():
    # Establish connections
    hive_conn = connect_hive()
    oracle_conn = connect_oracle()

    try:
        # Fetch data from Hive and Oracle
        hive_data = fetch_hive_data(ppnr_hive_query, hive_conn)
        oracle_data = fetch_oracle_data(ppnr_oracle_query, oracle_conn)

        # Generate accuracy report
        attribute_name = 'FCFEE_CHRGFF_RVRSL_AMT'  # Replace with relevant attribute
        merged_data, accuracy_score = generate_accuracy_report(hive_data, oracle_data, attribute_name)

        # Save the report
        merged_data.to_csv('accuracy_report.csv', index=False)
        print(f"Accuracy Report Generated. Accuracy: {accuracy_score:.2f}%")
    finally:
        # Close connections
        hive_conn.close()
        oracle_conn.close()

if __name__ == "__main__":
    main()
