#!/bin/bash

# Define paths for input and output files
JOB_CONF="JOB_CONF"
QUERY_FILE="$JOB_CONF/pcds_tbl_par.txt"
SOURCE_OUTPUT_FILE="SETFILE_PATH/source_count.csv"

# Retrieve credentials using Python
credentials=$(python3 <<EOF
import sys
sys.path.insert(0, '/path/to/recon_config')  # Update this path to the location of recon_config.py
import recon_config
print("{}:{}@{}".format(recon_config.username, recon_config.password, recon_config.db_name))
EOF
)

# Check if credentials were retrieved successfully
if [ -z "$credentials" ]; then
    echo "Error: Failed to retrieve credentials."
    exit 1
fi

echo "Retrieved credentials: $credentials"

# Check if the input file exists
if [ ! -f "$QUERY_FILE" ]; then
    echo "Error: Input file '$QUERY_FILE' does not exist!"
    exit 1
fi

# Display the content of the input file
echo "Processing file: $QUERY_FILE"
cat "$QUERY_FILE"

# Clear the output file and add headers
echo "Table Name, Database Name, Row Count" > "$SOURCE_OUTPUT_FILE"

# Execute a Hive query and append results to the output file
echo "Executing Hive query..."
hive -e "SELECT 'cds_acct_tbl' AS TableName, 'cds_db' AS DatabaseName, COUNT(*) AS RowCount FROM cds.acct_tbl UNION ALL SELECT 'cyc_tbl', 'cds_db', COUNT(*) FROM cds.cyc_tbl;" >> "$SOURCE_OUTPUT_FILE"

# Verify if the query executed and data was appended
if [ $? -ne 0 ]; then
    echo "Error: Hive query execution failed."
    exit 1
fi

echo "Query execution completed. Results saved to $SOURCE_OUTPUT_FILE"

# Display the output file content
echo "Output file content:"
cat "$SOURCE_OUTPUT_FILE"

# Exit the script successfully
exit 0
