import os
import socket
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email import encoders
from email_body import EmailStructures

# Email configuration function
def environmentval():
    # Get the first 4 characters of the hostname
    edgenode_env = socket.gethostname()[:4]
    print(f"edgenode_env is {edgenode_env}")
    
    # Define mappings for known environments
    environment_mappings = {
        "dcds": ("DEV", "UAT87@mo-collab.barclayscorp.com"), 
        "qcds": ("QA", "UAT87@mo-collab.barclayscorp.com"),
        "pcds": ("PROD", "IDTeamImpairment@barclays.com, USCDSRTBTEAM@barclays.com"),
    }

    # Check if the environment is recognized
    if edgenode_env in environment_mappings:
        upper_edgenode_env, mailto = environment_mappings[edgenode_env]
    else:
        raise ValueError(f"Unknown environment: {edgenode_env}")

    # Print environment details
    print(f"Environment: {upper_edgenode_env}")
    print(f"Mail To: {mailto}")
    return mailto

# Function to send an email with an attachment
def send_email_with_attachment(subject, body, attachment_path, recipients):
    try:
        # Email sender configuration
        sender_email = "noreply-fin-notification@barclaycardus.com"
        smtp_server = "smtp-relay-uat.barclays.intranet"
        smtp_port = 25
        
        # Create the email
        message = MIMEMultipart()
        message["From"] = sender_email
        message["To"] = recipients
        message["Subject"] = subject
        
        # Add the email body
        message.attach(MIMEText(body, "plain"))
        
        # Attach the CSV file
        with open(attachment_path, "rb") as attachment:
            part = MIMEBase("application", "octet-stream")
            part.set_payload(attachment.read())
        encoders.encode_base64(part)
        part.add_header("Content-Disposition", f"attachment; filename={os.path.basename(attachment_path)}")
        message.attach(part)
        
        # Send the email
        with smtplib.SMTP(smtp_server, smtp_port) as server:
            server.sendmail(sender_email, recipients.split(","), message.as_string())
        print(f"Email sent successfully to {recipients}")
    
    except Exception as e:
        print(f"Error sending email: {e}")

# Main execution logic
if __name__ == "__main__":
    try:
        # Retrieve the email recipient based on the environment
        mailto = environmentval()
        
        # Create an instance of EmailStructures with subject, body, and attachment
        subject = "Oracle and Hive Table Count Comparison Results"
        body = "Please find attached the comparison results between Oracle and Hive table counts."
        attachment_path = os.path.join("/default/path", "compare.csv")
        
        # Create the email structure
        email = EmailStructures(subject, body, attachment_path)
        
        # Format the email body
        email_content = email.format_email()
        
        # Send the email
        send_email_with_attachment(subject, email_content, attachment_path, mailto)
    
    except Exception as e:
        print(f"Error during execution: {e}")
