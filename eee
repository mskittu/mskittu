import csv
from datetime import datetime


if __name__ == "__main__":
    try:
        # Retrieve the email recipient
        mailto = "recipient_email@example.com"  # Replace with recipient's email

        # Read data from compare.csv
        compare_csv_file = "compare.csv"  # Replace with the correct file path
        table_data = []

        with open(compare_csv_file, "r") as file:
            csv_reader = csv.DictReader(file)
            for row in csv_reader:
                table_data.append({
                    "Table_Name": row["Table_Name"],
                    "Oracle_Count": row["Oracle_Count"],
                    "Hive_Count": row["Hive_Count"],
                    "Status": row["Status"],
                })

        # Generate the HTML table with headers and rows
        html_table = """
        <html>
            <body>
                <p>Please find below the comparison results between Oracle and Hive table counts:</p>
                <table border="1" style="border-collapse: collapse; text-align: left;">
                    <tr>
                        <th>Table_Name</th>
                        <th>Oracle_Count</th>
                        <th>Hive_Count</th>
                        <th>Status</th>
                    </tr>
        """
        for row in table_data:
            html_table += f"""
                    <tr>
                        <td>{row['Table_Name']}</td>
                        <td>{row['Oracle_Count']}</td>
                        <td>{row['Hive_Count']}</td>
                        <td>{row['Status']}</td>
                    </tr>
            """
        html_table += """
                </table>
            </body>
        </html>
        """

        # Print the generated table (for verification)
        print("Generated HTML Body:\n", html_table)

        # Get today's date in "YYYY-MM-DD" format
        today_date = datetime.now().strftime("%Y-%m-%d")

        # Subject with today's date
        subject = f"Oracle_and_Hive_Comparison_{today_date}"

        # Send the email
        send_email_with_attachment(subject, html_table, compare_csv_file, mailto)

    except Exception as e:
        print(f"Error during execution: {e}")
