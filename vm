import subprocess

def get_hive_table_count():
    try:
        # Output file for raw Hive query results
        raw_output_file = "/apps/tenant_local/usrf_stg/HadoopSandbox/x01532741/job/fin_recon/mds_daily_tbl_recon/0.9/source/raw_hive_output.txt"
        # Output file for formatted CSV
        csv_output_file = "/apps/tenant_local/usrf_stg/HadoopSandbox/x01532741/job/fin_recon/mds_daily_tbl_recon/0.9/source/target_count.csv"

        # Hive query command
        hive_command = (
            'hive -e "SELECT \'acct_tbal_prcng_b_eoc_fact\' AS table_name, COUNT(*) AS count '
            'FROM usrf_ingest.cds_acct_tbal_prcng_b_eoc_fact '
            'UNION ALL '
            'SELECT \'acct_tbal_prcng_c_eoc_fact\' AS table_name, COUNT(*) AS count '
            'FROM usrf_ingest.cds_acct_thal_prcng_c_eoc_fact;" > {}'.format(raw_output_file)
        )

        # Execute the Hive command
        subprocess.run(hive_command, shell=True, check=True)

        # Read and process the raw output
        results = []
        with open(raw_output_file, 'r') as file:
            for line in file:
                line = line.strip()
                # Skip unwanted lines (e.g., errors or blank lines)
                if not line or "ERROR" in line or "main" in line:
                    continue
                # Split and append table name and count
                parts = line.split()
                if len(parts) == 2:
                    table_name, count = parts
                    results.append((table_name, int(count)))

        # Write the formatted results to a CSV file
        with open(csv_output_file, 'w', newline='') as csv_file:
            csv_file.write("Hive_Table_Name,Count\n")  # Write the header
            for table_name, count in results:
                csv_file.write(f"{table_name},{count}\n")  # Write each row

        print(f"Hive table counts written to '{csv_output_file}'.")
        return results

    except subprocess.CalledProcessError as e:
        print("Error executing Hive query:", e)
        return None
    except ValueError as e:
        print(f"Error processing Hive query output: {e}")
        return None
